################################################################################
# Backstage Helm Values
# Uses platform-params ConfigMap for infrastructure values
# Domain values are injected by ApplicationSet via Helm parameters
################################################################################

# Global values (injected by ApplicationSet)
global:
  domain: ""  # Will be set by ApplicationSet from ConfigMap
  albGroupName: ""  # Will be set by ApplicationSet from ConfigMap

backstage:
  replicas: 1

  # Inject environment variables from ConfigMaps
  extraEnvVarsCM:
    - platform-params

  # Inject environment variables from Secrets  
  extraEnvVarsSecrets:
    - backstage-cognito
    - backstage-postgresql

  # Backstage app-config (uses environment variable substitution at runtime)
  appConfig:
    app:
      title: Internal Developer Platform
      baseUrl: ${BACKSTAGE_DOMAIN:+https://${BACKSTAGE_DOMAIN}}

    backend:
      baseUrl: ${BACKSTAGE_DOMAIN:+https://${BACKSTAGE_DOMAIN}}
      listen:
        port: 7007
        host: 0.0.0.0
      database:
        client: pg
        connection:
          host: ${POSTGRES_HOST}
          port: ${POSTGRES_PORT}
          user: ${POSTGRES_USER}
          password: ${POSTGRES_PASSWORD}
          database: ${POSTGRES_DB}

    # Cognito SSO - values from Secret
    auth:
      environment: development
      providers:
        oidc:
          development:
            metadataUrl: ${COGNITO_ISSUER}/.well-known/openid-configuration
            clientId: ${COGNITO_CLIENT_ID}
            clientSecret: ${COGNITO_CLIENT_SECRET}
            prompt: auto
            signIn:
              resolvers:
                - resolver: emailMatchingUserEntityProfileEmail

    # Catalog configuration
    catalog:
      rules:
        - allow: [Component, System, API, Resource, Location]
      locations:
        - type: url
          target: https://github.com/backstage/backstage/blob/master/packages/catalog-model/examples/all.yaml

  # Resources
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi

# Ingress with shared ALB
# Note: ingress.host is set via ArgoCD ApplicationSet parameter
# Ingress configuration
# Note: ACM certificate ARN and security group must be added via ApplicationSet parameters
# because they are dynamic values from Terraform
ingress:
  enabled: true
  className: alb
  host: ""  # Set via ArgoCD ApplicationSet parameter
  path: /
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/group.name: dev-platform
    alb.ingress.kubernetes.io/group.order: "200"
    alb.ingress.kubernetes.io/healthcheck-path: /healthcheck
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: "30"
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: "5"
    alb.ingress.kubernetes.io/healthy-threshold-count: "2"
    alb.ingress.kubernetes.io/unhealthy-threshold-count: "3"
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: "443"
    # External DNS for automatic Route53 record creation
    external-dns.alpha.kubernetes.io/hostname: ""  # Set via ApplicationSet

# PostgreSQL (in-cluster for development)
# Note: Using ephemeral storage for Phase 0 (dev environment)
# TODO: For production, enable persistence with EBS CSI driver IRSA
postgresql:
  enabled: true
  auth:
    username: backstage
    password: changeme-use-sealed-secrets
    database: backstage
  primary:
    persistence:
      enabled: false  # Disable for Phase 0 (no EBS CSI IRSA yet)
    resources:
      requests:
        cpu: 250m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
