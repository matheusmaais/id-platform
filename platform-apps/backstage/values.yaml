################################################################################
# Backstage Helm Values
# Uses platform-params ConfigMap for infrastructure values
# Domain values are injected by ApplicationSet via Helm parameters
################################################################################

# Global values (injected by ApplicationSet)
global:
  domain: "" # Will be set by ApplicationSet from ConfigMap
  albGroupName: "" # Will be set by ApplicationSet from ConfigMap
backstage:
  replicas: 1
  # Custom image with OIDC support (ARM64 for Graviton/t4g)
  # Image values are set via ApplicationSet Helm parameters (from platform-params.yaml)
  image:
    registry: "" # Set via ApplicationSet parameter from images.backstage.registry
    repository: "" # Set via ApplicationSet parameter from images.backstage.repository
    tag: "" # Set via ApplicationSet parameter from images.backstage.tag
  # Inject environment variables from ConfigMaps
  extraEnvVarsCM:
    - platform-params
  # Inject environment variables from Secrets  
  extraEnvVarsSecrets:
    - backstage-cognito
    - backstage-postgresql
    - backstage-github
  # Backstage app-config (uses environment variable substitution at runtime)
  appConfig:
    app:
      title: Internal Developer Platform
      baseUrl: https://${BACKSTAGE_DOMAIN}
      # Sign-in configuration - force OIDC login, disable guest
      signInPage: oidc
    backend:
      baseUrl: https://${BACKSTAGE_DOMAIN}
      listen:
        port: 7007
        host: 0.0.0.0
      database:
        client: pg
        connection:
          host: ${POSTGRES_HOST}
          port: ${POSTGRES_PORT}
          user: ${POSTGRES_USER}
          password: ${POSTGRES_PASSWORD}
          database: ${POSTGRES_DB}
    # Cognito SSO - values from Secret
    auth:
      environment: development
      session:
        secret: ${AUTH_SESSION_SECRET}
      providers:
        # Disable guest provider - force OIDC authentication
        guest: null
        oidc:
          development:
            metadataUrl: ${COGNITO_ISSUER}/.well-known/openid-configuration
            clientId: ${COGNITO_CLIENT_ID}
            clientSecret: ${COGNITO_CLIENT_SECRET}
            prompt: auto
    # GitHub integration (token)
    # NOTE: Keep token-based integration as default because GitHub App fields are not safely optional
    # in static YAML (empty env vars may break Backstage config parsing). ArgoCD SCM provider supports
    # GitHub App or token dynamically via Terraform.
    integrations:
      github:
        - host: github.com
          token: ${GITHUB_TOKEN}
    # Scaffolder defaults (from platform-params ConfigMap)
    scaffolder:
      defaultEnvironment:
        parameters:
          githubOrg: ${GITHUB_ORG}
          repoPrefix: ${GITHUB_REPO_PREFIX}
          repoRegex: ${GITHUB_REPO_REGEX}
          repoVisibility: ${GITHUB_REPO_VISIBILITY}
          githubAppName: ${GITHUB_APP_NAME}
          githubActionsRoleName: ${GITHUB_ACTIONS_ROLE_NAME}
          domain: ${DOMAIN}
          albGroupName: ${ALB_SHARED_GROUP_NAME}
          albScheme: ${ALB_SCHEME}
          albTargetType: ${ALB_TARGET_TYPE}
          albSecurityGroupId: ${ALB_SECURITY_GROUP_ID}
          acmCertificateArn: ${ACM_CERTIFICATE_ARN}
          ecrRegistry: ${ECR_REGISTRY}
          awsRegion: ${AWS_REGION}
          awsAccountId: ${AWS_ACCOUNT_ID}
          clusterName: ${CLUSTER_NAME}
          manifestsPath: ${APPS_MANIFESTS_PATH}
          appNamespaceStrategy: ${APPS_NAMESPACE_STRATEGY}
          appNamespaceTemplate: ${APPS_NAMESPACE_TEMPLATE}
          ciAuthMode: ${CI_AUTH_MODE}
          ciEcrRepoPrefix: ${CI_ECR_REPO_PREFIX}
          ciImageTagStrategy: ${CI_IMAGE_TAG_STRATEGY}
    # Platform identity policy (read by backend auth resolver)
    identity:
      allowedEmailDomains: ${AUTH_ALLOWED_EMAIL_DOMAINS}
    # Catalog configuration
    catalog:
      rules:
        - allow: [Component, System, API, Resource, Location]
      locations:
        - type: url
          target: ${PLATFORM_REPO_URL}/blob/${PLATFORM_REPO_BRANCH}/backstage-custom/templates/idp-nodejs-app/template.yaml
          rules:
            - allow: [Template]
        - type: url
          target: https://github.com/backstage/backstage/blob/master/packages/catalog-model/examples/all.yaml
  # Resources
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi
# Ingress with shared ALB
# Note: ingress.host is set via ArgoCD ApplicationSet parameter
# Ingress configuration
# Note: ACM certificate ARN and security group must be added via ApplicationSet parameters
# because they are dynamic values from Terraform
ingress:
  enabled: true
  className: alb
  host: "" # Set via ArgoCD ApplicationSet parameter
  path: /
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/group.name: "" # Set via ApplicationSet from ConfigMap
    alb.ingress.kubernetes.io/group.order: "20"
    alb.ingress.kubernetes.io/healthcheck-path: /healthcheck
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: "30"
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: "5"
    alb.ingress.kubernetes.io/healthy-threshold-count: "2"
    alb.ingress.kubernetes.io/unhealthy-threshold-count: "3"
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: "443"
    # External DNS for automatic Route53 record creation
    external-dns.alpha.kubernetes.io/hostname: "" # Set via ApplicationSet
# PostgreSQL (in-cluster for development)
# Note: Using ephemeral storage for Phase 0 (dev environment)
# TODO: For production, enable persistence with EBS CSI driver IRSA
postgresql:
  enabled: true
  auth:
    username: backstage
    password: changeme-use-sealed-secrets
    database: backstage
  primary:
    initdb:
      scripts:
        01-create-backstage-plugin-dbs.sql: |
          CREATE DATABASE "backstage_plugin_catalog" OWNER "backstage";
          CREATE DATABASE "backstage_plugin_search" OWNER "backstage";
          CREATE DATABASE "backstage_plugin_auth" OWNER "backstage";
          CREATE DATABASE "backstage_plugin_notifications" OWNER "backstage";
    persistence:
      enabled: false # Disable for Phase 0 (no EBS CSI IRSA yet)
    resources:
      requests:
        cpu: 250m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
